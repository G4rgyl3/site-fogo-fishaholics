<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé£ Fish Per Cast Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Single source of truth for styling -->
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <div class="pageGrid">
    <div class="card">
      <header>
        <h1>üé£ Fish Per Cast</h1>
        <div class="subtitle">Sliders, typing, and a tiny curve.</div>
      </header>

      <div class="grid">
        <!-- Rod level -->
        <div class="control">
          <div class="control-top">
            <div class="label">Rod Level</div>
            <div class="valueBox">
              <input id="levelNum" type="number" min="1" max="60" step="1" value="10" />
              <span class="pill" id="levelHint">max 60</span>
            </div>
          </div>
          <input id="levelRange" type="range" min="1" max="60" step="1" value="10" />
        </div>

        <!-- Difficulty -->
        <div class="control">
          <div class="control-top">
            <div class="label">Difficulty</div>
            <div class="valueBox">
              <input id="diffNum" type="number" min="1" max="256000000" step="1" value="1" />
              <span class="pill" id="diffHint">min 1</span>
            </div>
          </div>
          <input id="diffRange" type="range" min="1" max="256000000" step="1" value="1" />
        </div>
      </div>

      <div class="results">
        <div class="row">
          <span>Rod Power</span>
          <span class="value" id="rodPowerOut">‚Äî</span>
        </div>
        <div class="row">
          <span>Catch Chance</span>
          <span class="value" id="catchChanceOut">‚Äî</span>
        </div>
        <div class="row">
          <span>Expected FISH / Cast</span>
          <span class="value highlight" id="fishPerCastOut">‚Äî</span>
        </div>
      </div>

      <div class="chartWrap">
        <div class="chartHead">
          <div class="chartTitle">Mini chart: expected FISH/cast vs level</div>
          <div class="chartMeta" id="chartMeta">Difficulty: ‚Äî</div>
        </div>
        <canvas id="chart" width="900" height="560"></canvas>
      </div>

      <footer>Using fish.js game math</footer>
    </div>

    <div class="card">
      <div class="titleRow">
        <div>
          <div class="title">üì° Player Stats</div>
          <div class="sub">Live on-chain state + events.</div>
        </div>
      </div>

      <div class="onchainGrid" style="grid-template-columns: 1fr; margin-top: 0;">
        <div class="control">
          <div class="control-top">
            <div class="label">On-chain sync</div>
            <span class="pill" id="chainStatus">idle</span>
          </div>
          <div class="valueBox" style="justify-content: space-between; width: 100%;">
            <input id="ownerAddr" placeholder="Owner wallet pubkey (optional)" style="width: 100%; max-width: 320px;" />
            <button id="syncChain">Load from chain</button>
          </div>
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="setAsMe" title="Save this owner as your active player" disabled>Set as me</button>
              <button id="clearMe" title="Clear active player">Clear</button>
            </div>
            <span class="pill" id="activeMe">me: ‚Äî</span>
          </div>
        </div>

        <div class="control">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div class="label" style="font-size: 14px;">On-chain snapshot</div>
            <span class="pill" id="chainUpdated">‚Äî</span>
          </div>
          <div id="chainSnapshot" style="margin-top:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
            <div style="opacity:0.7;">No data loaded yet.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dedicated Player Scanner card (separate from Player Stats) -->
    <div class="card" id="playerScanCard">
      <div class="titleRow">
        <div>
          <div class="title">üß≠ Player Scanner</div>
          <div class="sub">Scan all PlayerState accounts (filtered by discriminator) and show a quick leaderboard sample.</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button id="scanPlayers">Scan players</button>
          <span class="pill" id="scanStatus">idle</span>
        </div>
      </div>

      <div class="scanBarWrap" style="margin-top: 12px;">
        <div class="scanBar" id="scanBar"></div>
      </div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <div class="sub" id="scanCount">‚Äî</div>
        <div class="sub">Top unprocessed (sample)</div>
      </div>

      <ul class="clean" id="scanTop" style="margin-top:10px;"></ul>
    </div>

    <div class="card full" id="processingCard">
      <div class="titleRow">
        <div>
          <div class="title">üêü Fish Processing</div>
          <div class="sub">Detects on-chain <code>process_fish</code> and logs player + amount.</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <label class="pill" style="cursor:pointer; user-select:none;">
            <input id="procLiveToggle" type="checkbox" style="margin:0 8px 0 0; transform: translateY(1px);" checked />
            Live
          </label>
          <span class="pill" id="procStatus">starting‚Ä¶</span>
        </div>
      </div>

      <div class="control" style="margin-top: 12px;">
        <div class="label">Rolling log (latest first)</div>
        <ul class="clean" id="processedFeed"></ul>
      </div>
    </div>
  </div>

  <!-- Your math lives here -->
  <script src="fish.js"></script>

  <script>
    const els = {
      levelNum: document.getElementById('levelNum'),
      levelRange: document.getElementById('levelRange'),
      diffNum: document.getElementById('diffNum'),
      diffRange: document.getElementById('diffRange'),
      rodPowerOut: document.getElementById('rodPowerOut'),
      catchChanceOut: document.getElementById('catchChanceOut'),
      fishPerCastOut: document.getElementById('fishPerCastOut'),
      chart: document.getElementById('chart'),
      chartMeta: document.getElementById('chartMeta'),
    };

    function clamp(n, min, max) {
      n = Number.isFinite(n) ? n : min;
      return Math.min(Math.max(n, min), max);
    }

    function syncPair(from, to) {
      to.value = from.value;
    }

    function formatPercent(p) {
      return (p * 100).toFixed(2) + '%';
    }

    function formatInt(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return '‚Äî';
      return x.toLocaleString();
    }

    function formatFish(x) {
      if (!Number.isFinite(x)) return '‚Äî';
      if (x === 0) return '0';
      if (Math.abs(x) < 1e-6) return x.toExponential(2);
      // keep 6dp but add commas to the whole part
      const s = x.toFixed(6);
      const [w, f] = s.split('.');
      const ww = w.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return f ? `${ww}.${f}` : ww;
    }

    function formatInt(n) {
      if (!Number.isFinite(n)) return '‚Äî';
      return Math.trunc(n).toLocaleString();
    }

    // --- Chart drawing (vanilla canvas) ---
    function drawChart(level, difficulty) {
      const ctx = els.chart.getContext('2d');
      const W = els.chart.width;
      const H = els.chart.height;

      const maxLevel = Number(els.levelRange.max);
      const points = [];
      let maxY = 0;

      for (let lvl = 1; lvl <= maxLevel; lvl++) {
        const y = calculateExpectedFishPerCast(lvl, difficulty);
        points.push({ x: lvl, y });
        if (Number.isFinite(y)) maxY = Math.max(maxY, y);
      }

      if (maxY <= 0) maxY = 1;
      const yPad = maxY * 0.15;
      const yMax = maxY + yPad;

      const padL = 44, padR = 16, padT = 14, padB = 34;
      const plotW = W - padL - padR;
      const plotH = H - padT - padB;

      const xMin = 1, xMax = maxLevel;
      const xToPx = (x) => padL + ((x - xMin) / (xMax - xMin)) * plotW;
      const yToPx = (y) => padT + (1 - (y / yMax)) * plotH;

      ctx.clearRect(0, 0, W, H);

      // Gridlines
      ctx.globalAlpha = 0.35;
      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      ctx.lineWidth = 1;

      const yTicks = 4;
      for (let i = 0; i <= yTicks; i++) {
        const yy = padT + (i / yTicks) * plotH;
        ctx.beginPath();
        ctx.moveTo(padL, yy);
        ctx.lineTo(W - padR, yy);
        ctx.stroke();
      }

      const xTicks = 6;
      for (let i = 0; i <= xTicks; i++) {
        const xx = padL + (i / xTicks) * plotW;
        ctx.beginPath();
        ctx.moveTo(xx, padT);
        ctx.lineTo(xx, H - padB);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // Axes labels
      ctx.fillStyle = 'rgba(148,163,184,0.9)';
      ctx.font = '16px system-ui, -apple-system, sans-serif';
      ctx.fillText('Level', W / 2 - 18, H - 10);
      ctx.save();
      ctx.translate(14, H / 2 + 30);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('FISH/cast', 0, 0);
      ctx.restore();

      // Line
      ctx.strokeStyle = 'rgba(56,189,248,0.95)';
      ctx.lineWidth = 3;
      ctx.beginPath();

      points.forEach((pt, i) => {
        const px = xToPx(pt.x);
        const py = yToPx(pt.y);
        if (i === 0) ctx.moveTo(px, py);
        else ctx.lineTo(px, py);
      });

      ctx.stroke();

      // Highlight current level point
      const current = points[level - 1];
      if (current) {
        const cx = xToPx(current.x);
        const cy = yToPx(current.y);

        ctx.beginPath();
        ctx.arc(cx, cy, 10, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(167,139,250,0.18)';
        ctx.fill();

        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(167,139,250,0.95)';
        ctx.fill();
      }

      // Simple x-axis ticks
      ctx.fillStyle = 'rgba(148,163,184,0.9)';
      ctx.font = '14px system-ui, -apple-system, sans-serif';
      const tickLevels = [1, 10, 20, 30, 40, 50, maxLevel].filter((v, i, a) => a.indexOf(v) === i);
      tickLevels.forEach((lvl) => {
        const px = xToPx(lvl);
        ctx.fillText(String(lvl), px - 8, H - padB + 22);
      });
    }

    function recalc() {
      const level = clamp(parseInt(els.levelNum.value, 10), 1, Number(els.levelRange.max));
      const difficulty = clamp(parseInt(els.diffNum.value, 10), 1, Number(els.diffRange.max));

      // enforce clamp back into inputs
      els.levelNum.value = level;
      els.levelRange.value = level;
      els.diffNum.value = difficulty;
      els.diffRange.value = difficulty;

      const power = rodPower(level);
      const catchChance = calculateCatchChance(level);
      const fishPerCast = calculateExpectedFishPerCast(level, difficulty);

      els.rodPowerOut.textContent = formatInt(power);
      els.catchChanceOut.textContent = formatPercent(catchChance);
      els.fishPerCastOut.textContent = formatFish(fishPerCast);

      els.chartMeta.textContent = `Difficulty: ${formatInt(difficulty)}`;
      drawChart(level, difficulty);
    }

    // expose for onchain-ui.js
    window.els = els;
    window.recalc = recalc;

    function wirePair(rangeEl, numEl) {
      rangeEl.addEventListener('input', () => {
        syncPair(rangeEl, numEl);
        recalc();
      });
      numEl.addEventListener('input', () => {
        const v = parseInt(numEl.value, 10);
        if (Number.isFinite(v)) {
          numEl.value = v;
          syncPair(numEl, rangeEl);
          recalc();
        }
      });
      numEl.addEventListener('change', recalc);
    }

    wirePair(els.levelRange, els.levelNum);
    wirePair(els.diffRange, els.diffNum);

    recalc();
  </script>

  <!-- On-chain logic extracted into its own module file -->
  <script type="module" src="./onchain-ui.js"></script>

  <!-- Optional: tx debugging helper (not loaded by default) -->
  <!-- <script type="module" src="./tx-debug.js"></script> -->
</body>
</html>
